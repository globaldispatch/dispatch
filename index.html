<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Dispatch — International Affairs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root { --ink:#0f0e0b; --paper:#f5f0e8; --cream:#ede7d6; --red:#c0392b; --gold:#b8860b; --muted:#6b6355; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--paper); color:var(--ink); font-family:'IBM Plex Sans',sans-serif; font-size:16px; line-height:1.6; min-height:100vh; }

  /* TICKER */
  .ticker { background:var(--ink); overflow:hidden; padding:0.4rem 0; border-bottom:2px solid var(--red); }
  .ticker-inner { display:flex; animation:scroll 30s linear infinite; white-space:nowrap; }
  .ticker-inner span { font-family:'IBM Plex Mono',monospace; font-size:0.65rem; letter-spacing:0.1em; text-transform:uppercase; padding:0 3rem; color:var(--gold); }
  .ticker-inner span::before { content:"◆  "; color:var(--red); }
  @keyframes scroll { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

  /* HEADER */
  header { border-bottom:3px solid var(--ink); padding:0 2rem; background:var(--paper); position:sticky; top:0; z-index:100; }
  .header-top { display:flex; align-items:center; justify-content:space-between; padding:0.75rem 0; border-bottom:1px solid var(--ink); gap:0.5rem; }
  .dateline { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.08em; color:var(--muted); text-transform:uppercase; }
  .masthead { font-family:'Playfair Display',serif; font-size:clamp(1.6rem,5vw,3.5rem); font-weight:900; letter-spacing:-0.02em; text-align:center; line-height:1; }
  .masthead span { color:var(--red); }
  nav { display:flex; overflow-x:auto; }
  nav a { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.1em; text-transform:uppercase; text-decoration:none; color:var(--ink); padding:0.6rem 1rem; border-right:1px solid var(--ink); white-space:nowrap; transition:background 0.15s,color 0.15s; cursor:pointer; }
  nav a:first-child { border-left:1px solid var(--ink); }
  nav a:hover, nav a.active { background:var(--ink); color:var(--paper); }

  /* BUTTONS */
  .publish-btn { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.1em; text-transform:uppercase; background:var(--red); color:white; border:none; padding:0.6rem 1.2rem; cursor:pointer; transition:opacity 0.15s; white-space:nowrap; }
  .publish-btn:hover { opacity:0.85; }
  .admin-btn { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.1em; text-transform:uppercase; background:transparent; color:var(--muted); border:1px solid var(--muted); padding:0.5rem 1rem; cursor:pointer; transition:border-color 0.15s,color 0.15s; white-space:nowrap; }
  .admin-btn:hover { border-color:var(--ink); color:var(--ink); }
  .btn-primary { font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.1em; text-transform:uppercase; background:var(--ink); color:var(--paper); border:2px solid var(--ink); padding:0.75rem 2rem; cursor:pointer; transition:background 0.15s; }
  .btn-primary:hover { background:var(--red); border-color:var(--red); }
  .btn-secondary { font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.1em; text-transform:uppercase; background:transparent; color:var(--muted); border:2px solid var(--muted); padding:0.75rem 1.5rem; cursor:pointer; transition:border-color 0.15s,color 0.15s; }
  .btn-secondary:hover { border-color:var(--ink); color:var(--ink); }
  .btn-danger { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.1em; text-transform:uppercase; background:none; border:1px solid var(--red); color:var(--red); padding:0.5rem 1rem; cursor:pointer; transition:background 0.15s,color 0.15s; }
  .btn-danger:hover { background:var(--red); color:white; }

  /* VIEWS */
  .view { display:none; }
  .view.active { display:block; }

  /* LOADING */
  .loading { text-align:center; padding:4rem 2rem; grid-column:1/-1; }
  .loading p { font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); }
  .spinner { width:24px; height:24px; border:2px solid var(--cream); border-top-color:var(--ink); border-radius:50%; animation:spin 0.7s linear infinite; margin:0 auto 1rem; }
  @keyframes spin { to{transform:rotate(360deg)} }

  /* FEED */
  .feed { max-width:1200px; margin:0 auto; padding:2rem; }
  .feed-header { display:flex; align-items:baseline; justify-content:space-between; border-bottom:1px solid var(--ink); padding-bottom:0.5rem; margin-bottom:1.5rem; }
  .feed-header h2 { font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.15em; text-transform:uppercase; }
  .article-count { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; color:var(--muted); }
  .articles-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:0; }
  .article-card { border:1px solid var(--ink); margin:-1px 0 0 -1px; padding:1.5rem; cursor:pointer; transition:background 0.15s; }
  .article-card:hover { background:var(--cream); }
  .article-card.featured { grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:2rem; padding:2rem; background:var(--ink); color:var(--paper); }
  .article-card.featured:hover { background:#1a1917; }
  .article-card.featured .card-meta { color:var(--gold); }
  .article-card.featured .card-excerpt { color:#c5bfb3; }
  .article-card.featured .card-tag { background:var(--red); color:white; border-color:var(--red); }
  .card-meta { font-family:'IBM Plex Mono',monospace; font-size:0.65rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--red); margin-bottom:0.5rem; display:flex; gap:0.75rem; align-items:center; }
  .card-meta .sep { color:var(--muted); }
  .card-title { font-family:'Playfair Display',serif; font-size:1.35rem; font-weight:700; line-height:1.25; margin-bottom:0.75rem; }
  .article-card.featured .card-title { font-size:clamp(1.5rem,3vw,2.2rem); }
  .card-excerpt { font-size:0.875rem; color:var(--muted); line-height:1.7; margin-bottom:1rem; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
  .card-tag { display:inline-block; font-family:'IBM Plex Mono',monospace; font-size:0.6rem; letter-spacing:0.1em; text-transform:uppercase; border:1px solid var(--ink); padding:0.15rem 0.5rem; }
  .card-author { margin-top:1rem; padding-top:0.75rem; border-top:1px solid currentColor; opacity:0.4; font-size:0.8rem; font-family:'IBM Plex Mono',monospace; }
  .empty-state { text-align:center; padding:5rem 2rem; grid-column:1/-1; }
  .empty-state h3 { font-family:'Playfair Display',serif; font-size:1.5rem; margin-bottom:0.5rem; }
  .empty-state p { color:var(--muted); font-size:0.9rem; }

  /* EDITOR */
  .editor-wrap { max-width:860px; margin:0 auto; padding:2rem; }
  .editor-heading { font-family:'Playfair Display',serif; font-size:1.75rem; font-weight:700; margin-bottom:0.25rem; }
  .editor-sub { color:var(--muted); font-size:0.875rem; margin-bottom:2rem; }
  .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:1.5rem; }
  .form-group { display:flex; flex-direction:column; gap:0.4rem; }
  .form-group.full { grid-column:1/-1; }
  label { font-family:'IBM Plex Mono',monospace; font-size:0.65rem; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); }
  input[type="text"], input[type="password"], select, textarea { background:white; border:1px solid var(--ink); padding:0.65rem 0.75rem; font-family:'IBM Plex Sans',sans-serif; font-size:0.9rem; color:var(--ink); outline:none; transition:border-color 0.15s,box-shadow 0.15s; width:100%; -webkit-appearance:none; }
  input:focus, select:focus, textarea:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(192,57,43,0.12); }
  textarea { resize:vertical; min-height:320px; line-height:1.8; }
  #editor-title { font-family:'Playfair Display',serif; font-size:1.2rem; }
  select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%230f0e0b'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 0.75rem center; padding-right:2rem; }
  .form-actions { display:flex; gap:1rem; align-items:center; padding-top:1.5rem; border-top:1px solid var(--ink); flex-wrap:wrap; }
  .char-count { font-family:'IBM Plex Mono',monospace; font-size:0.65rem; color:var(--muted); margin-left:auto; }

  /* READER */
  .reader { max-width:720px; margin:0 auto; padding:2rem; }
  .back-btn { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.1em; text-transform:uppercase; background:none; border:none; cursor:pointer; color:var(--muted); padding:0; margin-bottom:2rem; display:inline-flex; align-items:center; gap:0.5rem; transition:color 0.15s; }
  .back-btn:hover { color:var(--ink); }
  .reader-category { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--red); margin-bottom:1rem; }
  .reader-title { font-family:'Playfair Display',serif; font-size:clamp(1.75rem,4vw,2.75rem); font-weight:900; line-height:1.15; margin-bottom:1.25rem; border-bottom:3px solid var(--ink); padding-bottom:1.25rem; }
  .reader-meta { display:flex; gap:1.5rem; flex-wrap:wrap; margin-bottom:2rem; font-family:'IBM Plex Mono',monospace; font-size:0.7rem; color:var(--muted); }
  .reader-body { font-size:1rem; line-height:1.9; white-space:pre-wrap; font-weight:300; }
  .reader-actions { margin-top:3rem; padding-top:1.5rem; border-top:1px solid var(--ink); display:flex; gap:1rem; }

  /* ABOUT */
  .about-wrap { max-width:1100px; margin:0 auto; padding:2rem; }
  .about-header { border-bottom:3px solid var(--ink); padding-bottom:1.5rem; margin-bottom:3rem; }
  .about-header h1 { font-family:'Playfair Display',serif; font-size:clamp(2rem,5vw,3.5rem); font-weight:900; line-height:1.1; margin-bottom:0.75rem; }
  .about-header p { font-size:1rem; color:var(--muted); max-width:600px; line-height:1.8; }
  .section-header { display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--ink); padding-bottom:0.5rem; margin-bottom:2rem; }
  .section-header h2 { font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.15em; text-transform:uppercase; }
  .team-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:2rem; margin-bottom:3rem; }
  .team-card { border:1px solid var(--ink); overflow:hidden; }
  .team-photo { width:100%; aspect-ratio:1; object-fit:cover; display:block; }
  .team-photo-placeholder { width:100%; aspect-ratio:1; background:var(--cream); display:flex; align-items:center; justify-content:center; font-family:'Playfair Display',serif; font-size:4rem; color:var(--muted); border-bottom:1px solid var(--ink); }
  .team-info { padding:1.25rem; }
  .team-name { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; margin-bottom:0.25rem; }
  .team-role { font-family:'IBM Plex Mono',monospace; font-size:0.65rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--red); margin-bottom:0.75rem; }
  .team-bio { font-size:0.85rem; color:var(--muted); line-height:1.7; }
  .team-card-actions { padding:0.75rem 1.25rem; border-top:1px solid var(--cream); }
  .team-add-form { border:2px dashed var(--ink); padding:2rem; margin-bottom:2rem; display:none; }
  .team-add-form h3 { font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); margin-bottom:1.5rem; }
  .photo-upload-area { border:1px solid var(--ink); background:white; padding:1.5rem; text-align:center; transition:background 0.15s; }
  .photo-upload-area:hover { background:var(--cream); }
  .photo-file-input { display:block; width:100%; margin-bottom:0.5rem; font-family:'IBM Plex Mono',monospace; font-size:0.7rem; color:var(--muted); cursor:pointer; }
  .photo-upload-label { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); display:block; margin-top:0.5rem; }
  .photo-preview-img { width:80px; height:80px; object-fit:cover; border:1px solid var(--ink); margin:0 auto 0.5rem; display:none; }

  /* MODAL */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(15,14,11,0.75); z-index:500; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--paper); border:2px solid var(--ink); padding:2.5rem; width:100%; max-width:380px; margin:1rem; }
  .modal h3 { font-family:'Playfair Display',serif; font-size:1.5rem; margin-bottom:0.25rem; }
  .modal p { font-size:0.85rem; color:var(--muted); margin-bottom:1.5rem; }
  .modal input { width:100%; background:white; border:1px solid var(--ink); padding:0.65rem 0.75rem; font-family:'IBM Plex Sans',sans-serif; font-size:0.9rem; color:var(--ink); outline:none; margin-bottom:1rem; }
  .modal input:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(192,57,43,0.12); }
  .modal-actions { display:flex; gap:0.75rem; }
  .modal-error { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; color:var(--red); margin-bottom:0.75rem; display:none; }

  /* TOAST */
  .toast { position:fixed; bottom:2rem; right:2rem; background:var(--ink); color:var(--paper); font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.08em; padding:0.75rem 1.25rem; z-index:999; transform:translateY(4rem); opacity:0; transition:transform 0.3s,opacity 0.3s; pointer-events:none; max-width:90vw; }
  .toast.show { transform:translateY(0); opacity:1; }

  /* FIREBASE NOT CONFIGURED BANNER */
  .config-banner { background:var(--red); color:white; padding:1rem 2rem; font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.05em; text-align:center; display:none; }
  .config-banner.show { display:block; }

  /* MOBILE */
  @media (max-width:640px) {
    .form-row { grid-template-columns:1fr; }
    .article-card.featured { grid-template-columns:1fr; }
    .articles-grid { grid-template-columns:1fr; }
    .article-card { margin:0 0 -1px 0; }
    nav a { padding:0.6rem 0.7rem; font-size:0.6rem; }
    .feed, .editor-wrap, .reader, .about-wrap { padding:1rem; }
    .team-grid { grid-template-columns:1fr; }
    .dateline { display:none; }
    header { padding:0 1rem; }
  }
</style>
</head>
<body>

<!-- CONFIG BANNER -->
<div class="config-banner" id="config-banner">
  ⚠ Firebase not configured — open the file and paste your Firebase config values into the FIREBASE CONFIG section at the top of the script.
</div>

<div class="ticker">
  <div class="ticker-inner">
    <span>Global Dispatch</span><span>International Affairs Publishing</span><span>Geopolitics · Diplomacy · Economics · Conflict · Climate</span>
    <span>Global Dispatch</span><span>International Affairs Publishing</span><span>Geopolitics · Diplomacy · Economics · Conflict · Climate</span>
  </div>
</div>

<header>
  <div class="header-top">
    <div class="dateline" id="dateline"></div>
    <div class="masthead">Global <span>Dispatch</span></div>
    <div id="header-actions">
      <button class="admin-btn" onclick="window.openLogin()">Admin</button>
    </div>
  </div>
  <nav>
    <a class="active" onclick="window.showFeed(null,this)">All</a>
    <a onclick="window.showFeed('geopolitics',this)">Geopolitics</a>
    <a onclick="window.showFeed('diplomacy',this)">Diplomacy</a>
    <a onclick="window.showFeed('conflict',this)">Conflict</a>
    <a onclick="window.showFeed('economics',this)">Economics</a>
    <a onclick="window.showFeed('climate',this)">Climate</a>
    <a onclick="window.showFeed('human-rights',this)">Human Rights</a>
    <a onclick="window.gotoAbout(this)">About Us</a>
  </nav>
</header>

<!-- FEED -->
<div class="view active" id="view-feed">
  <div class="feed">
    <div class="feed-header">
      <h2 id="feed-title">Latest Dispatches</h2>
      <span class="article-count" id="article-count"></span>
    </div>
    <div class="articles-grid" id="articles-grid">
      <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
    </div>
  </div>
</div>

<!-- EDITOR -->
<div class="view" id="view-editor">
  <div class="editor-wrap">
    <h2 class="editor-heading">New Dispatch</h2>
    <p class="editor-sub">Publish your international affairs analysis to the platform.</p>
    <div class="form-row">
      <div class="form-group full">
        <label>Headline *</label>
        <input type="text" id="editor-title" placeholder="Article headline..." maxlength="180">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Author / Byline *</label>
        <input type="text" id="editor-author" placeholder="e.g. Dr. Sarah Chen">
      </div>
      <div class="form-group">
        <label>Region</label>
        <select id="editor-region">
          <option value="Global">Global</option>
          <option value="Europe">Europe</option>
          <option value="Middle East">Middle East</option>
          <option value="Asia-Pacific">Asia-Pacific</option>
          <option value="Americas">Americas</option>
          <option value="Africa">Africa</option>
          <option value="South Asia">South Asia</option>
          <option value="Central Asia">Central Asia</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Category *</label>
        <select id="editor-category">
          <option value="geopolitics">Geopolitics</option>
          <option value="diplomacy">Diplomacy</option>
          <option value="conflict">Conflict</option>
          <option value="economics">Economics</option>
          <option value="climate">Climate</option>
          <option value="human-rights">Human Rights</option>
        </select>
      </div>
      <div class="form-group">
        <label>Subheadline / Summary</label>
        <input type="text" id="editor-excerpt" placeholder="Short summary shown on card">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group full">
        <label>Article Body *</label>
        <textarea id="editor-body" placeholder="Write your full article here..."></textarea>
      </div>
    </div>
    <div class="form-actions">
      <button class="btn-primary" onclick="window.publishArticle()">Publish Dispatch</button>
      <button class="btn-secondary" onclick="window.showFeed(null,document.querySelector('nav a'))">Cancel</button>
      <span class="char-count" id="char-count">0 characters</span>
    </div>
  </div>
</div>

<!-- READER -->
<div class="view" id="view-reader">
  <div class="reader" id="reader-content"></div>
</div>

<!-- ABOUT -->
<div class="view" id="view-about">
  <div class="about-wrap">
    <div class="about-header">
      <h1>About Global <em>Dispatch</em></h1>
      <p>Global Dispatch is an independent platform dedicated to rigorous analysis of international affairs, geopolitics, economics, and diplomacy from perspectives around the world.</p>
    </div>
    <div class="section-header">
      <h2>Our Team</h2>
      <button class="admin-btn" id="add-member-btn" style="display:none" onclick="window.toggleAddForm()">+ Add Member</button>
    </div>
    <div class="team-add-form" id="team-add-form">
      <h3>Add Team Member</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" id="tm-name" placeholder="e.g. Dr. Sarah Chen">
        </div>
        <div class="form-group">
          <label>Role / Title *</label>
          <input type="text" id="tm-role" placeholder="e.g. Senior Editor">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>Bio</label>
          <textarea id="tm-bio" style="min-height:100px" placeholder="A short biography..."></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>Photo</label>
          <div class="photo-upload-area">
            <img class="photo-preview-img" id="photo-preview-img">
            <input class="photo-file-input" type="file" accept="image/jpeg,image/png,image/webp" id="tm-photo-input" onchange="window.previewPhoto(this)">
            <span class="photo-upload-label" id="photo-upload-label">Select a JPG or PNG photo</span>
          </div>
        </div>
      </div>
      <div class="form-actions" style="border-top:none;padding-top:0.5rem">
        <button class="btn-primary" onclick="window.addTeamMember()">Add Member</button>
        <button class="btn-secondary" onclick="window.toggleAddForm()">Cancel</button>
      </div>
    </div>
    <div class="team-grid" id="team-grid">
      <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal-overlay" id="login-modal">
  <div class="modal">
    <h3>Admin Access</h3>
    <p>Enter your password to publish and manage content.</p>
    <div class="modal-error" id="login-error">Incorrect password. Try again.</div>
    <input type="password" id="login-password" placeholder="Password" onkeydown="if(event.key==='Enter')window.submitLogin()">
    <div class="modal-actions">
      <button class="btn-primary" onclick="window.submitLogin()">Sign In</button>
      <button class="btn-secondary" onclick="window.closeLogin()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
  // ============================================================
  // FIREBASE CONFIG — PASTE YOUR VALUES FROM FIREBASE HERE
  // ============================================================
  const firebaseConfig = {
    apiKey:            "AIzaSyDu335won_68iOJqQo-TP697JBd6wkBnRw",
    authDomain:        "global-dispatch.firebaseapp.com",
    projectId:         "global-dispatch",
    storageBucket:     "global-dispatch.firebasestorage.app",
    messagingSenderId: "146868891463",
    appId:             "1:146868891463:web:266ef89b14849e87956662"
  };
  // ============================================================

  const ADMIN_PASSWORD = 'Tender23bird$';

  // Check config is filled in
  const configured = !Object.values(firebaseConfig).some(v => v.startsWith('PASTE_'));
  if (!configured) {
    document.getElementById('config-banner').classList.add('show');
  }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let articles = [];
  let team = [];
  let activeFilter = null;
  let isAdmin = sessionStorage.getItem('gd_admin') === '1';
  let pendingPhotoData = null;

  document.getElementById('dateline').textContent =
    new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // ── LOAD DATA ──
  async function loadArticles() {
    try {
      const q = query(collection(db, 'articles'), orderBy('date', 'desc'));
      const snap = await getDocs(q);
      articles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch(e) {
      console.error('Error loading articles:', e);
      const grid = document.getElementById('articles-grid');
      if (grid) grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><h3>Error loading articles</h3><p>${e.message}</p></div>`;
      return;
    }
    renderFeed();
  }

  async function loadTeam() {
    const grid = document.getElementById('team-grid');
    if (grid) grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading team...</p></div>';
    try {
      const snap = await getDocs(collection(db, 'team'));
      team = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch(e) {
      console.error('Error loading team:', e);
      const grid = document.getElementById('team-grid');
      if (grid) grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><h3>Error loading team</h3><p>${e.message}</p></div>`;
      return;
    }
    renderTeam();
  }

  // ── ADMIN ──
  function updateAdminUI() {
    const actions = document.getElementById('header-actions');
    actions.innerHTML = isAdmin
      ? `<button class="publish-btn" onclick="window.showView('editor')">+ New Article</button>
         <button class="admin-btn" style="margin-left:0.5rem" onclick="window.logout()">Sign Out</button>`
      : `<button class="admin-btn" onclick="window.openLogin()">Admin</button>`;
    const btn = document.getElementById('add-member-btn');
    if (btn) btn.style.display = isAdmin ? 'inline-block' : 'none';
  }

  window.openLogin = function() {
    document.getElementById('login-modal').classList.add('open');
    document.getElementById('login-password').value = '';
    document.getElementById('login-error').style.display = 'none';
    setTimeout(() => document.getElementById('login-password').focus(), 100);
  };
  window.closeLogin = function() { document.getElementById('login-modal').classList.remove('open'); };

  window.submitLogin = function() {
    if (document.getElementById('login-password').value === ADMIN_PASSWORD) {
      isAdmin = true;
      sessionStorage.setItem('gd_admin', '1');
      closeLogin();
      updateAdminUI();
      showToast('Welcome back, Admin.');
    } else {
      document.getElementById('login-error').style.display = 'block';
      document.getElementById('login-password').value = '';
      document.getElementById('login-password').focus();
    }
  };

  window.logout = function() {
    isAdmin = false;
    sessionStorage.removeItem('gd_admin');
    updateAdminUI();
    showFeed(null, document.querySelector('nav a'));
    showToast('Signed out.');
  };

  document.getElementById('login-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeLogin(); });

  // ── NAV ──
  function setActiveNav(el) {
    document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
    if (el) el.classList.add('active');
  }

  window.showView = function(name) {
    if (name === 'editor' && !isAdmin) { openLogin(); return; }
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-' + name).classList.add('active');
    if (name === 'editor') clearEditor();
    window.scrollTo(0, 0);
  };

  window.showFeed = function(cat, el) {
    activeFilter = cat;
    document.getElementById('feed-title').textContent = cat
      ? cat.charAt(0).toUpperCase() + cat.slice(1).replace('-', ' ')
      : 'Latest Dispatches';
    showView('feed');
    renderFeed();
    setActiveNav(el);
  };

  window.gotoAbout = function(el) {
    showView('about');
    setActiveNav(el);
    updateAdminUI();
    loadTeam();
  };

  // ── ARTICLES ──
  function clearEditor() {
    ['editor-title','editor-author','editor-excerpt','editor-body'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('editor-category').value = 'geopolitics';
    document.getElementById('editor-region').value = 'Global';
    document.getElementById('char-count').textContent = '0 characters';
  }

  document.getElementById('editor-body').addEventListener('input', function() {
    document.getElementById('char-count').textContent = this.value.length.toLocaleString() + ' characters';
  });

  window.publishArticle = async function() {
    if (!isAdmin) { openLogin(); return; }
    const title = document.getElementById('editor-title').value.trim();
    const author = document.getElementById('editor-author').value.trim();
    const body = document.getElementById('editor-body').value.trim();
    if (!title || !author || !body) { showToast('Please fill in headline, author, and body.'); return; }
    showToast('Publishing...');
    try {
      const article = {
        title, author, body,
        excerpt: document.getElementById('editor-excerpt').value.trim() || body.slice(0, 160) + '…',
        category: document.getElementById('editor-category').value,
        region: document.getElementById('editor-region').value,
        date: new Date().toISOString(),
      };
      const docRef = await addDoc(collection(db, 'articles'), article);
      articles.unshift({ id: docRef.id, ...article });
      showFeed(null, document.querySelector('nav a'));
      showToast('Article published!');
    } catch(e) {
      console.error(e);
      showToast('Error publishing. Check Firebase config.');
    }
  };

  function renderFeed() {
    const grid = document.getElementById('articles-grid');
    const list = activeFilter ? articles.filter(a => a.category === activeFilter) : articles;
    document.getElementById('article-count').textContent = list.length + ' article' + (list.length !== 1 ? 's' : '');
    if (list.length === 0) {
      grid.innerHTML = `<div class="empty-state"><h3>No dispatches yet</h3><p>${activeFilter ? 'No articles in this category.' : 'No articles published yet.'}</p></div>`;
      return;
    }
    grid.innerHTML = list.map((a, i) => {
      const dateStr = new Date(a.date).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
      const featured = i === 0 && !activeFilter;
      return `<div class="article-card ${featured ? 'featured' : ''}" onclick="window.readArticle('${a.id}')">
        <div>
          <div class="card-meta"><span>${escHtml(a.category)}</span><span class="sep">·</span><span>${escHtml(a.region)}</span></div>
          <div class="card-title">${escHtml(a.title)}</div>
        </div>
        <div>
          <div class="card-excerpt">${escHtml(a.excerpt)}</div>
          <span class="card-tag">${escHtml(a.category)}</span>
          <div class="card-author">By ${escHtml(a.author)} &nbsp;·&nbsp; ${dateStr}</div>
        </div>
      </div>`;
    }).join('');
  }

  window.readArticle = function(id) {
    const a = articles.find(x => x.id === id);
    if (!a) return;
    const d = new Date(a.date);
    document.getElementById('reader-content').innerHTML = `
      <button class="back-btn" onclick="window.showFeed(null,document.querySelector('nav a'))">← Back to Feed</button>
      <div class="reader-category">${escHtml(a.category)} &nbsp;·&nbsp; ${escHtml(a.region)}</div>
      <h1 class="reader-title">${escHtml(a.title)}</h1>
      <div class="reader-meta">
        <span>By ${escHtml(a.author)}</span>
        <span>${d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</span>
        <span>${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</span>
        <span>${a.body.split(' ').length} words</span>
      </div>
      <div class="reader-body">${escHtml(a.body)}</div>
      ${isAdmin ? `<div class="reader-actions"><button class="btn-danger" onclick="window.deleteArticle('${a.id}')">Delete Article</button></div>` : ''}
    `;
    showView('reader');
  };

  window.deleteArticle = async function(id) {
    if (!isAdmin || !confirm('Delete this article permanently?')) return;
    try {
      await deleteDoc(doc(db, 'articles', id));
      articles = articles.filter(a => a.id !== id);
      showFeed(null, document.querySelector('nav a'));
      showToast('Article deleted.');
    } catch(e) {
      showToast('Error deleting article.');
    }
  };

  // ── TEAM ──
  window.toggleAddForm = function() {
    const form = document.getElementById('team-add-form');
    form.style.display = form.style.display === 'block' ? 'none' : 'block';
    if (form.style.display === 'block') form.scrollIntoView({ behavior:'smooth' });
  };

  window.previewPhoto = function(input) {
    const file = input.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { showToast('Please select an image file.'); input.value = ''; return; }
    const reader = new FileReader();
    reader.onload = e => {
      pendingPhotoData = e.target.result;
      const img = document.getElementById('photo-preview-img');
      img.src = pendingPhotoData;
      img.style.display = 'block';
      document.getElementById('photo-upload-label').textContent = '✓ ' + file.name;
    };
    reader.onerror = () => showToast('Error reading image.');
    reader.readAsDataURL(file);
  };

  window.addTeamMember = async function() {
    if (!isAdmin) { openLogin(); return; }
    const name = document.getElementById('tm-name').value.trim();
    const role = document.getElementById('tm-role').value.trim();
    const bio = document.getElementById('tm-bio').value.trim();
    if (!name || !role) { showToast('Please fill in name and role.'); return; }
    
    const btn = document.querySelector('#team-add-form .btn-primary');
    if (btn) { btn.textContent = 'Saving...'; btn.disabled = true; }
    
    try {
      // If photo is too large, skip it to avoid Firestore limits
      let photo = pendingPhotoData || null;
      if (photo && photo.length > 900000) {
        showToast('Photo too large — saving without photo.');
        photo = null;
      }
      const member = { name, role, bio, photo, order: Date.now() };
      const docRef = await addDoc(collection(db, 'team'), member);
      team.push({ id: docRef.id, ...member });
      ['tm-name','tm-role','tm-bio'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('tm-photo-input').value = '';
      document.getElementById('photo-preview-img').style.display = 'none';
      document.getElementById('photo-upload-label').textContent = 'Select a JPG or PNG photo';
      pendingPhotoData = null;
      document.getElementById('team-add-form').style.display = 'none';
      renderTeam();
      showToast('Team member added!');
    } catch(e) {
      console.error('addTeamMember error:', e);
      showToast('Error: ' + (e.message || 'Could not save. Check connection.'));
    } finally {
      if (btn) { btn.textContent = 'Add Member'; btn.disabled = false; }
    }
  };

  window.deleteTeamMember = async function(id) {
    if (!isAdmin || !confirm('Remove this team member?')) return;
    try {
      await deleteDoc(doc(db, 'team', id));
      team = team.filter(m => m.id !== id);
      renderTeam();
      showToast('Team member removed.');
    } catch(e) {
      showToast('Error removing member.');
    }
  };

  function renderTeam() {
    const addBtn = document.getElementById('add-member-btn');
    if (addBtn) addBtn.style.display = isAdmin ? 'inline-block' : 'none';
    const grid = document.getElementById('team-grid');
    if (!grid) return;
    if (team.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><h3>No team members yet</h3><p>${isAdmin ? 'Click "+ Add Member" to get started.' : ''}</p></div>`;
      return;
    }
    grid.innerHTML = team.map(m => `
      <div class="team-card">
        ${m.photo
          ? `<img class="team-photo" src="${m.photo}" alt="${escHtml(m.name)}">`
          : `<div class="team-photo-placeholder">${escHtml(m.name.charAt(0).toUpperCase())}</div>`}
        <div class="team-info">
          <div class="team-name">${escHtml(m.name)}</div>
          <div class="team-role">${escHtml(m.role)}</div>
          ${m.bio ? `<div class="team-bio">${escHtml(m.bio)}</div>` : ''}
        </div>
        ${isAdmin ? `<div class="team-card-actions"><button class="btn-danger" onclick="window.deleteTeamMember('${m.id}')">Remove</button></div>` : ''}
      </div>`).join('');
  }

  // ── UTILS ──
  window.showToast = function(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  };

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ── INIT ──
  updateAdminUI();
  loadArticles();
</script>
</body>
</html>
